{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}رزرو پرواز - برج سفید{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/flights.css' %}">
<style>
    .booking-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .booking-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 40px;
    }
    .flight-summary {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        margin-bottom: 40px;
    }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        text-align: center;
    }
    .summary-item strong { display: block; font-size: 1.4em; color: #2a5298; }

    .passengers-form {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        margin-bottom: 40px;
    }
    .passenger-form {
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        background: #f9f9f9;
    }
    .passenger-title {
        font-size: 1.4em;
        font-weight: bold;
        color: #2a5298;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #2a5298;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
    }
    .price-summary {
        background: #f0f8ff;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 40px;
    }
    .total-price {
        font-size: 2.8em;
        font-weight: bold;
        color: #2a5298;
    }
    .continue-btn {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border: none;
        padding: 18px 60px;
        border-radius: 12px;
        font-size: 1.4em;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s;
    }
    .continue-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(42,82,152,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="booking-container">
    <div class="booking-header">
        <h1>تکمیل رزرو پرواز</h1>
        <p>لطفاً اطلاعات مسافران را وارد کنید</p>
    </div>

    <!-- خلاصه پرواز -->
    <div class="flight-summary">
        <div class="summary-grid">
            <div class="summary-item">
                <strong>{{ flight.origin_city }} → {{ flight.destination_city }}</strong>
                <span>{{ flight.departure_time|date:"d F Y - H:i" }}</span>
            </div>
            <div class="summary-item">
                <strong>{{ flight.airline }}</strong>
                <span>پرواز {{ flight.flight_number }}</span>
            </div>
            <div class="summary-item">
                <strong>{{ total_passengers }} مسافر</strong>
                <span>بزرگسال: {{ adults }} | کودک: {{ children }} | نوزاد: {{ infants }}</span>
            </div>
            <div class="summary-item">
                <strong>{{ total_price|intcomma }} تومان</strong>
                <span>قیمت کل</span>
            </div>
        </div>
    </div>

    <!-- فرم اطلاعات مسافران -->
    <form method="POST">
        {% csrf_token %}
        <div class="passengers-form" id="passengers-container">
            <!-- فرم‌ها داینامیک با JS ساخته می‌شن -->
        </div>

        <div class="price-summary">
            <p>قیمت نهایی</p>
            <div class="total-price">{{ total_price|intcomma }} تومان</div>
        </div>
        <button type="submit" class="continue-btn">تکمیل رزرو و رفتن به پرداخت</button>
    </form>
</div>

<template id="passenger-template">
    <div class="passenger-form">
        <div class="passenger-title">مسافر <span class="num">1</span> - <span class="type">بزرگسال</span></div>
        <div class="form-grid">
            <div class="form-group">
                <label>نام</label>
                <input type="text" name="first_name" required>
            </div>
            <div class="form-group">
                <label>نام خانوادگی</label>
                <input type="text" name="last_name" required>
            </div>
            <div class="form-group">
                <label>کد ملی</label>
                <input type="text" name="national_id" maxlength="10" required>
            </div>
            <div class="form-group">
                <label>تاریخ تولد</label>
                <input type="date" name="birth_date" required>
            </div>
        </div>
    </div>
</template>

<script>
    const passengers = {
        adult: {{ adults|default:1 }},
        child: {{ children|default:0 }},
        infant: {{ infants|default:0 }}
    };

    function createPassengerForms() {
        const container = document.getElementById('passengers-container');
        container.innerHTML = '';

        const template = document.getElementById('passenger-template').content;
        let index = 1;

        ['adult', 'child', 'infant'].forEach(type => {
            const typeFa = type === 'adult' ? 'بزرگسال' : type === 'child' ? 'کودک' : 'نوزاد';
            for (let i = 0; i < passengers[type]; i++) {
                const clone = document.importNode(template, true);
                clone.querySelector('.num').textContent = index;
                clone.querySelector('.type').textContent = typeFa;

                // همه inputها رو با [] برای getlist درست کن
                clone.querySelector('input[name="first_name"]').name = 'first_name[]';
                clone.querySelector('input[name="last_name"]').name = 'last_name[]';
                clone.querySelector('input[name="national_id"]').name = 'national_id[]';
                clone.querySelector('input[name="birth_date"]').name = 'birth_date[]';

                container.appendChild(clone);
                index++;
            }
        });
    }

    // اولیه
    createPassengerForms();
</script>
{% endblock %}


